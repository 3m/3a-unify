// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MEMBER
  CREATOR
  ADMIN
}

enum SubscriptionTier {
  FREE
  BRONZE
  SILVER
  GOLD
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
  EVENT
}

enum ChatType {
  DM
  GROUP
}

enum NotificationType {
  NEW_POST
  NEW_EVENT
  NEW_FOLLOWER
  NEW_MESSAGE
  LIKE
  COMMENT
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  name              String?
  nickname          String?
  avatar            String?
  bio               String?
  role              Role                @default(MEMBER)
  subscriptionTier  SubscriptionTier    @default(FREE)
  displayBadges     Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  creator           Creator?
  comments          Comment[]
  likes             Like[]
  sentMessages      Message[]
  chatParticipants  ChatParticipant[]
  notifications     Notification[]
  subscriptions     Subscription[]      @relation("UserSubscriptions")
  interests         UserInterest[]
  following         Follow[]            @relation("UserFollowing")
  eventRegistrations EventRegistration[]
  friends           Friendship[]        @relation("UserFriends")
  friendOf          Friendship[]        @relation("FriendOfUser")
}

model Creator {
  id              String    @id @default(cuid())
  userId          String    @unique
  subscriberCount Int       @default(0)
  postCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts           Post[]
  events          Event[]
  subscriptions   Subscription[]      @relation("CreatorSubscriptions")
  followers       Follow[]
}

model Post {
  id          String            @id @default(cuid())
  creatorId   String
  content     String
  mediaUrls   String[]
  tier        SubscriptionTier  @default(FREE)
  type        PostType          @default(TEXT)
  likesCount  Int               @default(0)
  commentsCount Int             @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  creator     Creator           @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]

  @@index([creatorId])
  @@index([tier])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Event {
  id          String            @id @default(cuid())
  creatorId   String
  title       String
  description String?
  price       Float             @default(0)
  date        DateTime
  tier        SubscriptionTier  @default(FREE)
  status      String            @default("Coming Soon...")
  imageUrl    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  creator     Creator           @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  registrations EventRegistration[]

  @@index([creatorId])
  @@index([date])
}

model EventRegistration {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model Chat {
  id          String   @id @default(cuid())
  type        ChatType @default(DM)
  name        String?
  lastMessage String?
  lastMessageAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  participants ChatParticipant[]
  messages     Message[]
}

model ChatParticipant {
  id        String   @id @default(cuid())
  chatId    String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  senderId  String
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
}

model Notification {
  id        String            @id @default(cuid())
  userId    String
  type      NotificationType
  content   String
  read      Boolean           @default(false)
  createdAt DateTime          @default(now())

  // Relations
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model Subscription {
  id                  String            @id @default(cuid())
  userId              String
  creatorId           String
  tier                SubscriptionTier
  status              String            @default("active")
  stripeSubscriptionId String?          @unique
  stripePriceId       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  user                User              @relation("UserSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  creator             Creator           @relation("CreatorSubscriptions", fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([userId, creatorId])
  @@index([userId])
  @@index([creatorId])
}

model Interest {
  id        String   @id @default(cuid())
  name      String   @unique
  tag       String   @unique
  createdAt DateTime @default(now())

  // Relations
  users     UserInterest[]
}

model UserInterest {
  id         String   @id @default(cuid())
  userId     String
  interestId String
  createdAt  DateTime @default(now())

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([userId, interestId])
  @@index([userId])
  @@index([interestId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  // Relations
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   Creator  @relation(fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  friendId  String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend    User     @relation("FriendOfUser", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
}
